---
// @ts-nocheck
import Base from '../../layouts/Base.astro';
import { getLeagueBySlug } from '../../lib/leagues.js';
import { getUpcomingMatchesByLeague, getRecentMatchesByLeague } from '../../lib/matches.js';
import { metaBasic } from '../../lib/seo.js';
import { SITE_URL } from '../../lib/env.js';

const { slug } = Astro.params;
/** @type {any} */
let league = null;
/** @type {any[]} */
let upcoming = [];
/** @type {{ rows: any[]; page: number; pageSize: number; hasNext: boolean }} */
let recent = { rows: [], page: 1, pageSize: 50, hasNext: false };
/** @type {string|null} */
let error = null;

try {
  league = await getLeagueBySlug(slug);
  if (!league) throw new Error('League not found');
  upcoming = await getUpcomingMatchesByLeague(slug, 168);
  recent = await getRecentMatchesByLeague(slug, 30, 1, 50);
} catch (e) {
  error = 'Service unavailable';
  Astro.response.status = 503;
}

const siteUrl = SITE_URL;
const pageTitle = league ? `${league.name} (${league.country})` : 'Liga';
const meta = metaBasic(pageTitle, `Partidos de ${league?.name || ''} en ${league?.country || ''}. Próximos y recientes.`, `${siteUrl}/liga/${slug}`);

const fmtDateTime = (s) => new Date(s).toLocaleString('es-ES', { dateStyle: 'medium', timeStyle: 'short' });
---
<Base { ...meta }>
  <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight mb-6">{league ? league.name : 'Liga'}</h1>

  { error ? (
    <div class="card p-6 text-red-600">{error}</div>
  ) : (
    <>
      <section class="mb-8">
        <h2 class="text-xl font-bold mb-3">Próximos (0–168 h)</h2>
        {upcoming.length === 0 ? (
          <p class="text-sm text-gray-600">No hay partidos próximos.</p>
        ) : (
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            {upcoming.map((m) => (
              <a href={`/partido/${m.slug}`} class="card p-4 hover:shadow-md transition">
                <div class="flex items-center justify-between">
                  <h3 class="font-semibold">{m.home_team} <span class="text-gray-400">vs</span> {m.away_team}</h3>
                  <span class="text-xs text-gray-500">J{m.matchday ?? '—'}</span>
                </div>
                <p class="text-sm text-gray-600">{m.league_name} · {m.league_country}</p>
                <p class="text-sm text-gray-600">{fmtDateTime(m.date)}</p>
              </a>
            ))}
          </div>
        )}
      </section>

      <section>
        <h2 class="text-xl font-bold mb-3">Recientes (últimos 30 días)</h2>
        {recent.rows.length === 0 ? (
          <p class="text-sm text-gray-600">No hay resultados recientes.</p>
        ) : (
          <div class="overflow-x-auto card">
            <table class="min-w-full table-auto divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Partido</th>
                  <th class="px-4 py-3"></th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200 bg-white">
                {recent.rows.map((m) => (
                  <tr>
                    <td class="px-4 py-3 text-sm text-gray-700 whitespace-nowrap">{fmtDateTime(m.date)}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">{m.home_team} <span class="text-gray-400">vs</span> {m.away_team}</td>
                    <td class="px-4 py-3 text-right">
                      <a href={`/partido/${m.slug}`} class="text-brand-700 hover:underline">Ver ficha</a>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </section>
    </>
  )}
</Base> 