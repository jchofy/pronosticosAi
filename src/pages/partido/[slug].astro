---
// @ts-nocheck
import Base from '../../layouts/Base.astro';
import { getMatchBySlug, getPredictionForMatch } from '../../lib/matches.js';
import { pageMetaForMatch } from '../../lib/seo.js';
import { SITE_URL } from '../../lib/env.js';
import { getActiveBettingHouses } from '../../lib/bettingHouses.js';

const { slug } = Astro.params;
/** @type {any} */
let match = null;
/** @type {{ text?: string|null; generatedAt?: string; bets?: Array<{ bet_type: string; selection: string; odds: number }> } | null} */
let prediction = null;
/** @type {Array<{ id:number; name:string; website_url:string; affiliate_code?: string|null; affiliate_url?: string|null; contact_email?: string|null; color:string; logo_file?: string|null; active?: number }>} */
let bettingHouses = [];

try {
  match = await getMatchBySlug(slug);
  if (!match) {
    throw new Response('Not found', { status: 404 });
  }
  prediction = await getPredictionForMatch(match.id);
  bettingHouses = await getActiveBettingHouses();
} catch (e) {
  if (e instanceof Response && e.status === 404) throw e;
  Astro.response.status = 503;
}

const siteUrl = SITE_URL;
const meta = match ? pageMetaForMatch(match, siteUrl) : { title: 'Partido', description: '', canonical: `${siteUrl}/partido/${slug}` };

const now = new Date();
const matchDate = match ? new Date(match.date) : new Date();
const isPast = match ? matchDate < now : false;
const isOld = match ? matchDate < new Date(Date.now() - 7 * 24 * 60 * 60 * 1000) : false;

const fmtDateTime = (s) => new Date(s).toLocaleString('es-ES', { dateStyle: 'full', timeStyle: 'short' });
const fmtShort = (s) => {
  try {
    const d = new Date(s);
    const weekday = d.toLocaleDateString('es-ES', { weekday: 'long' });
    const day = d.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
    const time = d.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
    return `${weekday}, ${day} · ${time}`;
  } catch { return ''; }
};
const fmtCap = (n) => (n ? Number(n).toLocaleString('es-ES') : null);
const normalizeHexColor = (c) => {
  try {
    const s = String(c || '').trim();
    if (!s) return '#0b5cff';
    if (s.startsWith('#') && s.length === 7) return s;
    if (!s.startsWith('#') && s.length === 6) return `#${s}`;
    return '#0b5cff';
  } catch {
    return '#0b5cff';
  }
};
const getContrastTextClass = (hex) => {
  const h = normalizeHexColor(hex).slice(1);
  const r = parseInt(h.slice(0,2), 16);
  const g = parseInt(h.slice(2,4), 16);
  const b = parseInt(h.slice(4,6), 16);
  const luminance = (0.2126*r + 0.7152*g + 0.0722*b) / 255;
  return luminance > 0.6 ? 'text-gray-900' : 'text-white';
};
---
<Base title={meta.title} description={meta.description} canonical={meta.canonical} jsonLd={meta.jsonLd} og={meta.og} noindex={isOld}>
  {match ? (
    <article class="prose prose-sm max-w-none">
      <div class="mb-2 flex items-center justify-between text-xs text-gray-600">
        <div class="inline-flex items-center gap-1 text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-4 w-4 text-gray-400"><path d="M12 22a10 10 0 1 1 0-20 10 10 0 0 1 0 20zm.75-10.44V7a.75.75 0 0 0-1.5 0v5a.75.75 0 0 0 .22.53l3 3a.75.75 0 1 0 1.06-1.06l-2.78-2.78z"/></svg>
          <span class="font-medium">{fmtShort(match.date)}</span>
        </div>
        <a href={`/liga/${match.league_slug}`} class="inline-flex items-center gap-2">
          {match.league_logo && <img src={`/${String(match.league_logo).replace(/^\/?public\//,'').replace(/^\//,'')}`} alt={match.league_name} class="h-10 w-10 md:h-12 md:w-12 rounded-md bg-white object-contain p-1 shadow-sm" width="48" height="48" loading="lazy" decoding="async" />}
          <span class="hidden sm:inline text-gray-700 hover:underline">{match.league_name}</span>
        </a>
      </div>

      <header class="mb-6 ">
        <div class="mb-3 grid grid-cols-[1fr_auto_1fr] items-center gap-3 not-prose">
          <div class="flex flex-col items-center gap-2 min-w-0">
            {match.home_logo && <img src={`/${String(match.home_logo).replace(/^\/?public\//,'').replace(/^\//,'')}`} alt={`Escudo ${match.home_team_name}`} title={match.home_team_name} class="h-12 w-12 team-logo" width="48" height="48" loading="lazy" decoding="async" />}
            <div class="font-extrabold leading-tight text-gray-900 text-center text-xl md:text-2xl">{match.home_team_name}</div>
          </div>
          <div class="text-center">
            <div class="inline-flex"><span class="badge badge-date">J{match.matchday ?? '—'}</span></div>
            <div class="mt-1 text-[11px] uppercase tracking-wide text-gray-400">vs</div>
          </div>
          <div class="flex flex-col items-center gap-2 min-w-0">
            {match.away_logo && <img src={`/${String(match.away_logo).replace(/^\/?public\//,'').replace(/^\//,'')}`} alt={`Escudo ${match.away_team_name}`} title={match.away_team_name} class="h-12 w-12 team-logo" width="48" height="48" loading="lazy" decoding="async" />}
            <div class="font-extrabold leading-tight text-gray-900 text-center text-xl md:text-2xl">{match.away_team_name}</div>
          </div>
        </div>
        {match.stadium && (
          <p class="not-prose text-xs text-gray-500">{match.stadium}{match.stadium_capacity ? ` · ${fmtCap(match.stadium_capacity)} espectadores` : ''}</p>
        )}
      </header>

      <section class="not-prose card p-5 bg-white/70">
        {prediction ? (
          <div class="space-y-5">
            {prediction.bets && prediction.bets.length > 0 && (
              <div>
                <h2 class="text-lg font-bold mb-3">Recomendación de apuesta</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  {prediction.bets.map((b) => (
                    <div class="bet-card">
                      <div class="min-w-0">
                        <div class="text-sm font-medium text-gray-900 truncate">{b.bet_type || '-'}</div>
                        <div class="text-xs text-gray-700 truncate">{b.selection || '-'}</div>
                      </div>
                      <div class="ml-3 bet-card-odds">
                        <span class="text-xs text-brand-700">Cuota</span>
                        <span class="badge badge-date text-sm">{typeof b.odds === 'number' ? b.odds.toFixed(2) : '-'}</span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
            {prediction.text && (
              <div>
                <h2 class="text-lg font-bold mb-2">Análisis del pronóstico</h2>
                <p class="text-sm text-gray-800">{prediction.text}</p>
              </div>
            )}
            {(!prediction.bets || prediction.bets.length === 0) && !prediction.text && (
              <p class="text-sm text-gray-600">Pronóstico próximamente.</p>
            )}
          </div>
        ) : (
          <p class="text-sm text-gray-600">Pronóstico próximamente.</p>
        )}
      </section>

      <section class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
        {/* Local team card */}
        <div class="card card-hover overflow-hidden">
          <div class="bg-gradient-to-r from-brand-50 to-white px-4 pt-4 pb-3 border-b border-gray-100">
            <div class="flex items-center gap-3">
              {match.home_logo && (
                <img
                  src={`/${String(match.home_logo).replace(/^\/?public\//,'').replace(/^\//,'')}`}
                  alt={`Escudo ${match.home_team_name}`}
                  title={match.home_team_name}
                  class="h-12 w-12 rounded-lg bg-white object-contain p-1 border border-gray-200 shadow-sm"
                  width="48"
                  height="48"
                  loading="lazy"
                  decoding="async"
                />
              )}
              <div class="min-w-0">
                <div class="text-xs uppercase tracking-wide text-gray-500">Local</div>
                <h3 class="font-bold text-lg text-gray-900 truncate">{match.home_team_name}</h3>
              </div>
              <div class="ml-auto flex items-center gap-2">
                {match.league_logo && (
                  <img
                    src={`/${String(match.league_logo).replace(/^\/?public\//,'').replace(/^\//,'')}`}
                    alt={match.league_name}
                    class="h-7 w-7 rounded-md bg-white object-contain p-1 border border-gray-200"
                    width="28"
                    height="28"
                    loading="lazy"
                    decoding="async"
                  />
                )}
                <span class="hidden sm:inline text-xs text-gray-600 truncate max-w-[120px]">{match.league_name}</span>
              </div>
            </div>
          </div>
          <div class="px-4 py-3">
            <dl class="space-y-2">
              {match.home_coach && (
                <div class="flex items-center gap-2 text-sm">
                  <svg class="h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm-7 9a7 7 0 0 1 14 0v1H5v-1z"/></svg>
                  <dt class="text-gray-500">Entrenador</dt>
                  <dd class="ml-auto font-medium text-gray-900 truncate">{match.home_coach}</dd>
                </div>
              )}
            </dl>
          </div>
        </div>

        {/* Away team card */}
        <div class="card card-hover overflow-hidden">
          <div class="bg-gradient-to-r from-white to-brand-50 px-4 pt-4 pb-3 border-b border-gray-100">
            <div class="flex items-center gap-3">
              {match.away_logo && (
                <img
                  src={`/${String(match.away_logo).replace(/^\/?public\//,'').replace(/^\//,'')}`}
                  alt={`Escudo ${match.away_team_name}`}
                  title={match.away_team_name}
                  class="h-12 w-12 rounded-lg bg-white object-contain p-1 border border-gray-200 shadow-sm"
                  width="48"
                  height="48"
                  loading="lazy"
                  decoding="async"
                />
              )}
              <div class="min-w-0">
                <div class="text-xs uppercase tracking-wide text-gray-500">Visitante</div>
                <h3 class="font-bold text-lg text-gray-900 truncate">{match.away_team_name}</h3>
              </div>
              <div class="ml-auto flex items-center gap-2">
                {match.league_logo && (
                  <img
                    src={`/${String(match.league_logo).replace(/^\/?public\//,'').replace(/^\//,'')}`}
                    alt={match.league_name}
                    class="h-7 w-7 rounded-md bg-white object-contain p-1 border border-gray-200"
                    width="28"
                    height="28"
                    loading="lazy"
                    decoding="async"
                  />
                )}
                <span class="hidden sm:inline text-xs text-gray-600 truncate max-w-[120px]">{match.league_name}</span>
              </div>
            </div>
          </div>
          <div class="px-4 py-3">
            <dl class="space-y-2">
              {match.away_coach && (
                <div class="flex items-center gap-2 text-sm">
                  <svg class="h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm-7 9a7 7 0 0 1 14 0v1H5v-1z"/></svg>
                  <dt class="text-gray-500">Entrenador</dt>
                  <dd class="ml-auto font-medium text-gray-900 truncate">{match.away_coach}</dd>
                </div>
              )}
            </dl>
          </div>
        </div>
      </section>

      {isPast && (
        <p class="text-xs text-gray-500 mt-4">Partido finalizado o en curso.</p>
      )}

      {bettingHouses && bettingHouses.length > 0 && (
        <section class="not-prose mt-8">
          <h2 class="text-lg font-bold mb-3">Casas recomendadas para tu depósito y bono</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {bettingHouses.map((bh) => {
              const color = normalizeHexColor(bh.color);
              const textClass = getContrastTextClass(color);
              const bgStyle = { backgroundColor: color };
              const link = bh.affiliate_url || bh.website_url;
              return (
                <a href={link} target="_blank" rel="nofollow noopener" class="block rounded-2xl overflow-hidden border border-gray-200 shadow-sm card-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500" style={bgStyle}>
                  <div class={`p-4 flex items-center gap-3 ${textClass}`}>
                    {bh.logo_file && (
                      <img src={`/${String(bh.logo_file).replace(/^\/?public\//,'').replace(/^\//,'')}`} alt={`Logo ${bh.name}`} width="80" height="80" loading="lazy" decoding="async" class="h-16 w-16 sm:h-20 sm:w-20 object-contain" />
                    )}
                    <div class="min-w-0">
                      <div class="text-sm/5 opacity-90">Casa recomendada</div>
                      <div class="font-semibold text-base truncate">{bh.name}</div>
                    </div>
                    <div class="ml-auto">
                      <span class={`inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-xs font-medium border ${textClass === 'text-white' ? 'border-white/50' : 'border-black/10'} ${textClass === 'text-white' ? 'text-white' : 'text-gray-900'} bg-black/10`}>Bono</span>
                    </div>
                  </div>
                  <div class={`px-4 pb-4 ${textClass}`}>
                    <p class="text-xs opacity-90">Deposita y reclama tu recompensa de bienvenida</p>
                  </div>
                </a>
              );
            })}
          </div>
          <p class="mt-2 text-[11px] text-gray-500">Enlaces de afiliado. Juega con responsabilidad.</p>
        </section>
      )}
    </article>
  ) : (
    <div class="card p-6 text-red-600">Service unavailable</div>
  )}
</Base> 