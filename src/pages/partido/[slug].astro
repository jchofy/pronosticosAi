---
// @ts-nocheck
import Base from '../../layouts/Base.astro';
import { getMatchBySlug } from '../../lib/matches.js';
import { pageMetaForMatch } from '../../lib/seo.js';
import { SITE_URL } from '../../lib/env.js';
import { getActiveBettingHouses } from '../../lib/bettingHouses.js';
import PredictionAccess from '../../components/PredictionAccess.astro';
import { getStripeProducts, formatPrice } from '../../lib/stripe-products.js';
import { STRIPE_PRICE_MATCH, STRIPE_PRICE_SUB_2DAY } from '../../lib/env.js';

const { slug } = Astro.params;
/** @type {any} */
let match = null;
/** @type {Array<{ id:number; name:string; website_url:string; affiliate_code?: string|null; affiliate_url?: string|null; contact_email?: string|null; color:string; logo_file?: string|null; active?: number }>} */
let bettingHouses = [];

// Obtener productos de Stripe para precios din√°micos
let matchPrice = '2.49‚Ç¨'; // Fallback
let subscriptionPrice = 'Desde 9.99‚Ç¨'; // Fallback

try {
  match = await getMatchBySlug(slug);
  if (!match) {
    throw new Response('Not found', { status: 404 });
  }
  bettingHouses = await getActiveBettingHouses();
  
  // Obtener precios espec√≠ficos de Stripe usando los IDs de las variables de entorno
  try {
    const { stripe } = await import('../../lib/stripe.js');
    
    // Obtener precio del partido individual (STRIPE_PRICE_MATCH)
    if (STRIPE_PRICE_MATCH) {
      try {
        const matchPriceData = await stripe.prices.retrieve(STRIPE_PRICE_MATCH);
        matchPrice = formatPrice(matchPriceData.unit_amount, matchPriceData.currency);
      } catch (e) {
        console.error('Error fetching match price:', e);
      }
    }
    
    // Obtener precio de suscripci√≥n m√°s barata (STRIPE_PRICE_SUB_2DAY)
    if (STRIPE_PRICE_SUB_2DAY) {
      try {
        const subPriceData = await stripe.prices.retrieve(STRIPE_PRICE_SUB_2DAY);
        subscriptionPrice = `Desde ${formatPrice(subPriceData.unit_amount, subPriceData.currency)}`;
      } catch (e) {
        console.error('Error fetching subscription price:', e);
      }
    }
    
  } catch (stripeError) {
    console.error('Error loading Stripe prices:', stripeError);
    // Usar precios por defecto si falla Stripe
  }
  
} catch (e) {
  if (e instanceof Response && e.status === 404) throw e;
  Astro.response.status = 503;
}

const siteUrl = SITE_URL;
const meta = match ? pageMetaForMatch(match, siteUrl) : { title: 'Partido', description: '', canonical: `${siteUrl}/partido/${slug}` };
const shareUrl = meta.canonical || `${siteUrl}/partido/${slug}`;
const shareText = match ? `Pron√≥stico con IA ${match.home_team_name} vs ${match.away_team_name}` : 'Pron√≥stico con IA';

const now = new Date();
const matchDate = match ? new Date(match.date) : new Date();
const isPast = match ? matchDate < now : false;
const isOld = match ? matchDate < new Date(Date.now() - 7 * 24 * 60 * 60 * 1000) : false;

const fmtDateTime = (s) => new Date(s).toLocaleString('es-ES', { dateStyle: 'full', timeStyle: 'short' });
const fmtShort = (s) => {
  try {
    const d = new Date(s);
    const weekday = d.toLocaleDateString('es-ES', { weekday: 'long' });
    const day = d.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
    const time = d.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
    return `${weekday}, ${day} ¬∑ ${time}`;
  } catch { return ''; }
};
const fmtCap = (n) => (n ? Number(n).toLocaleString('es-ES') : null);
const fmtDateEsShort = (s) => {
  try {
    const d = new Date(s);
    return String(d.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' })).replace(/\.$/, '');
  } catch { return ''; }
};
const normalizeHexColor = (c) => {
  try {
    const s = String(c || '').trim();
    if (!s) return '#0b5cff';
    if (s.startsWith('#') && s.length === 7) return s;
    if (!s.startsWith('#') && s.length === 6) return `#${s}`;
    return '#0b5cff';
  } catch {
    return '#0b5cff';
  }
};
const getContrastTextClass = (hex) => {
  const h = normalizeHexColor(hex).slice(1);
  const r = parseInt(h.slice(0,2), 16);
  const g = parseInt(h.slice(2,4), 16);
  const b = parseInt(h.slice(4,6), 16);
  const luminance = (0.2126*r + 0.7152*g + 0.0722*b) / 255;
  return luminance > 0.6 ? 'text-gray-900' : 'text-white';
};
---
<Base title={meta.title} description={meta.description} canonical={meta.canonical} jsonLd={[meta.jsonLd, meta.paywallJsonLd]} og={meta.og} noindex={isOld}>
  {match ? (
    <article class="prose prose-sm max-w-none">
      <div class="mb-2 flex items-center justify-between text-xs text-gray-600">
        <div class="inline-flex items-center gap-1 text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-4 w-4 text-gray-400"><path d="M12 22a10 10 0 1 1 0-20 10 10 0 0 1 0 20zm.75-10.44V7a.75.75 0 0 0-1.5 0v5a.75.75 0 0 0 .22.53l3 3a.75.75 0 1 0 1.06-1.06l-2.78-2.78z"/></svg>
          <span class="font-medium">{fmtShort(match.date)}</span>
        </div>
        <a href={`/liga/${match.league_slug}`} class="inline-flex items-center gap-2">
          {match.league_logo && <img src={`/${String(match.league_logo).replace(/^\/?public\//,'').replace(/^\//,'')}`} alt={match.league_name} class="h-10 w-10 md:h-12 md:w-12 rounded-md bg-white object-contain p-1 shadow-sm" width="48" height="48" loading="lazy" decoding="async" />}
          <span class="hidden sm:inline text-gray-700 hover:underline">{match.league_name}</span>
        </a>
      </div>

      <header class="mb-6 ">
        <h1 class="text-xl md:text-2xl font-bold leading-snug tracking-tight text-gray-900 not-prose">
          Pron√≥stico con IA {match.home_team_name} vs {match.away_team_name} ‚Äì an√°lisis de valor y cuotas {match.matchday ? `(J${match.matchday}, ${fmtDateEsShort(match.date)})` : `(${fmtDateEsShort(match.date)})`}
        </h1>
        <hr class="my-4  mb-6 "/>
       
        <div class="mb-3 grid grid-cols-[1fr_auto_1fr] items-center gap-3 not-prose">
          <div class="flex flex-col items-center gap-2 min-w-0">
            {match.home_logo && <img src={`/${String(match.home_logo).replace(/^\/?public\//,'').replace(/^\//,'')}`} alt={`Escudo ${match.home_team_name}`} title={match.home_team_name} class="h-12 w-12 team-logo" width="48" height="48" loading="lazy" decoding="async" />}
            <div class="font-extrabold leading-tight text-gray-900 text-center text-xl md:text-2xl">{match.home_team_name}</div>
          </div>
          <div class="text-center">
            <div class="inline-flex"><span class="badge badge-date">J{match.matchday ?? '‚Äî'}</span></div>
            <div class="mt-1 text-[11px] uppercase tracking-wide text-gray-400">vs</div>
          </div>
          <div class="flex flex-col items-center gap-2 min-w-0">
            {match.away_logo && <img src={`/${String(match.away_logo).replace(/^\/?public\//,'').replace(/^\//,'')}`} alt={`Escudo ${match.away_team_name}`} title={match.away_team_name} class="h-12 w-12 team-logo" width="48" height="48" loading="lazy" decoding="async" />}
            <div class="font-extrabold leading-tight text-gray-900 text-center text-xl md:text-2xl">{match.away_team_name}</div>
          </div>
        </div>
        {match.stadium && (
          <p class="not-prose text-xs text-gray-500">{match.stadium}{match.stadium_capacity ? ` ¬∑ ${fmtCap(match.stadium_capacity)} espectadores` : ''}</p>
        )}
      </header>

      <section class="not-prose card p-6 md:p-7 bg-white/80">
        <h2 class="text-xl md:text-2xl font-extrabold">Pron√≥stico</h2>
        <PredictionAccess matchId={match.id} homeTeamName={match.home_team_name} awayTeamName={match.away_team_name} />
                  <div id="prediction-upsell" class="mt-8 hidden">
            <div class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-primary-600 to-secondary-600 p-[2px]">
              <div class="relative rounded-2xl bg-white p-6 dark:bg-gray-900">
                <div class="absolute inset-0 bg-gradient-to-br from-primary-600/20 to-secondary-600/20 opacity-[0.15]"></div>
                <div class="relative">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <div class="flex h-10 w-10 items-center justify-center rounded-full bg-gradient-to-br from-primary-500 to-secondary-500">
                        <svg class="h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                      </div>
                      <div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                          Accede a nuestro an√°lisis detallado y predicciones
                        </p>
                      </div>
                    </div>
                  </div>

                  <div class="mt-6 grid gap-6 sm:grid-cols-2">
                    {/* Opci√≥n de compra individual */}
                    <div class="relative overflow-hidden rounded-xl border-2 border-gray-200 bg-white p-6 shadow-sm transition-all hover:border-primary-200 hover:shadow-md dark:border-gray-800 dark:bg-gray-800">
                      <div class="absolute inset-x-0 -top-px h-[2px] bg-gradient-to-r from-primary-500/0 via-primary-500/70 to-primary-500/0"></div>
                      <div class="mb-4">
                        <div class="flex items-center justify-between">
                          <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Partido individual</h4>
                          <span class="rounded-full bg-primary-50 px-3 py-1 text-sm font-medium text-primary-700 dark:bg-primary-900/30 dark:text-primary-400">
                            {matchPrice}
                          </span>
                        </div>
                        <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                          Acceso completo a este partido
                        </p>
                      </div>
                      <ul class="mb-6 space-y-3 text-sm text-gray-600 dark:text-gray-400">
                        <li class="flex items-center">
                          <svg class="mr-3 h-5 w-5 text-primary-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                          </svg>
                          An√°lisis detallado
                        </li>
                        <li class="flex items-center">
                          <svg class="mr-3 h-5 w-5 text-primary-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                          </svg>
                          Predicci√≥n IA
                        </li>
                      </ul>
                      <!-- Purchase button moved to main prediction section -->
                    </div>

                    {/* Opci√≥n de suscripci√≥n */}
                    <div class="relative overflow-hidden rounded-xl border-2 border-gray-200 bg-white p-6 shadow-sm transition-all hover:border-secondary-200 hover:shadow-md dark:border-gray-800 dark:bg-gray-800">
                      <div class="absolute inset-x-0 -top-px h-[2px] bg-gradient-to-r from-secondary-500/0 via-secondary-500/70 to-secondary-500/0"></div>
                      <div class="mb-4">
                        <div class="flex items-center justify-between">
                          <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Suscripci√≥n</h4>
                          <span class="rounded-full bg-secondary-50 px-3 py-1 text-sm font-medium text-secondary-700 dark:bg-secondary-900/30 dark:text-secondary-400">
                            {subscriptionPrice}
                          </span>
                        </div>
                        <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                          Acceso a todas las predicciones
                        </p>
                      </div>
                      <ul class="mb-6 space-y-3 text-sm text-gray-600 dark:text-gray-400">
                        <li class="flex items-center">
                          <svg class="mr-3 h-5 w-5 text-primary-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                          </svg>
                          An√°lisis detallado
                        </li>
                        <li class="flex items-center">
                          <svg class="mr-3 h-5 w-5 text-primary-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                          </svg>
                          Predicci√≥n IA
                        </li>
                        <li class="flex items-center">
                          <svg class="mr-3 h-5 w-5 text-primary-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                          </svg>
                          Desde 2 partidos al d√≠a
                        </li>
                      </ul>
                      <div class="mt-2">
                        <a 
                          href="/precios" 
                          class="block w-full rounded-lg bg-[#254FB1] px-4 py-2.5 text-center text-sm font-medium text-white shadow-sm hover:from-primary-600 hover:to-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                        >
                          Ver planes
                        </a>
                      </div>
                    </div>
                  </div>

                  <div class="mt-4 flex items-center justify-center text-sm text-gray-500 dark:text-gray-400">
                    <svg class="mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                    Pago seguro con Stripe
                  </div>
                </div>
            </div>
          </div>
        </div>
        <script>
          (function(){
            const boot = () => {
            /** @type {HTMLButtonElement|null} */
            const btn = document.getElementById('btn-view-prediction');
            /** @type {HTMLElement|null} */
            const outWrap = document.getElementById('prediction-container');
            /** @type {HTMLElement|null} */
            const out = document.getElementById('prediction-text');
            const betsEl = document.getElementById('prediction-bets');
            /** @type {HTMLElement|null} */
            const err = document.getElementById('prediction-error');
            /** @type {HTMLElement|null} */
            const upsell = document.getElementById('prediction-upsell');
            if (!btn) return;
            const matchIdAttr = btn.getAttribute('data-match-id');
            const matchId = matchIdAttr ? Number(matchIdAttr) : NaN;
            const teamHome = btn.getAttribute('data-home-name') || '';
            const teamAway = btn.getAttribute('data-away-name') || '';
            const setLoading = (v) => { v ? btn.setAttribute('aria-busy','true') : btn.removeAttribute('aria-busy'); try { (btn instanceof HTMLButtonElement) && (btn.disabled = Boolean(v)); } catch(_){} };
            const humanizeBet = (bet) => {
              const typeRaw = String(bet?.bet_type || '').toLowerCase();
              const selRaw = String(bet?.selection || '').toLowerCase();
              const normalize = (s) => s.replace(/\s+/g, '_').replace(/\./g, '_');
              const type = normalize(typeRaw);
              const sel = normalize(selRaw);
              if (type.includes('1x2') || type === '1x2') {
                if (['local','home','1'].includes(sel)) return { title: `${teamHome}`, subtitle: 'Mercado 1X2' };
                if (['visitante','away','2'].includes(sel)) return { title: `${teamAway}`, subtitle: 'Mercado 1X2' };
                if (['empate','x','draw'].includes(sel)) return { title: 'Empate', subtitle: 'Mercado 1X2' };
                return { title: 'Mercado 1X2', subtitle: bet?.selection || '' };
              }
              if (type.includes('ambos_anotan') || type.includes('btts')) {
                const si = ['si','s√≠','yes','y'].includes(sel);
                const no = ['no','n'].includes(sel);
                return { title: `Ambos anotan: ${si ? 'S√≠' : (no ? 'No' : (bet?.selection || ''))}`, subtitle: 'Goles' };
              }
              const parseOverUnder = (s) => {
                const m = s.match(/(over|under)[ _]?(\d+)[ _]?(\d)/);
                if (m) { return { kind: m[1], value: `${m[2]}.${m[3]}` }; }
                const m2 = s.match(/(over|under)[ _]?(\d+(?:[\._]\d+)?)/);
                if (m2) { return { kind: m2[1], value: m2[2].replace('_','.') }; }
                return null;
              };
              if (type.includes('over_under') || type.includes('goles') || type.includes('over') || type.includes('under') || sel.startsWith('over_') || sel.startsWith('under_') || type.startsWith('over_') || type.startsWith('under_')) {
                const info = parseOverUnder(sel) || parseOverUnder(type);
                if (info) {
                  const txt = info.kind === 'over' ? `M√°s de ${info.value} goles` : `Menos de ${info.value} goles`;
                  return { title: txt, subtitle: 'Total de goles' };
                }
              }
              // Fallback
              const nice = (s) => s.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase());
              return { title: nice(String(bet?.bet_type || '-')), subtitle: nice(String(bet?.selection || '')) };
            };

            const renderBetCard = (b) => {
              const h = humanizeBet(b);
              const odds = (typeof b?.odds === 'number') ? b.odds.toFixed(2) : '-';
              return `
                <div class=\"bet-card bet-card-strong\">
                  <div class=\"min-w-0\">
                    <div class=\"text-sm font-semibold text-gray-900 truncate\">${h.title}</div>
                    <div class=\"text-xs text-gray-700 truncate\">${h.subtitle}</div>
                  </div>
                  <div class=\"ml-3 bet-card-odds\">
                    <span class=\"odds-badge\">${odds}</span>
                  </div>
                </div>`;
            };
            // setHint function removed - now handled by UsageLimits component
            const setHint = (n) => {
              // Legacy function - no longer needed
            };
            // updateFreeHint function removed - now handled by UsageLimits component
            const updateFreeHint = async () => {
              // Legacy function - no longer needed
            };
            // updateFreeHint() call removed

            const renderPrediction = (data) => {
              if (!data) return false;
              // bets first
              try {
                const bets = Array.isArray(data?.bets) ? data.bets : [];
                if (betsEl && bets.length) {
                  betsEl.classList.remove('hidden');
                  betsEl.innerHTML = '<div class="flex items-center justify-between mb-3">\
                      <h3 class="text-lg font-bold">Apuesta recomendada</h3>\
                    </div>' +
                    '<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">' +
                    bets.map(renderBetCard).join('') + '</div>';
                }
              } catch {}
              if (out) out.textContent = data?.text || 'Pron√≥stico pr√≥ximamente.';
              outWrap && outWrap.classList.remove('hidden');
              btn && btn.classList.add('hidden');
              // refresh hint after reveal (may drop to 0)
              updateFreeHint();
              return true;
            };

            // Auto-open if user already has access (subscription, purchase, or prior grant)
            const autoOpen = async () => {
              try {
                const resp = await fetch(`/api/predictions/${matchId}`, { credentials: 'include' });
                if (resp.ok) {
                  const data = await resp.json();
                  if (data && (data.text || (Array.isArray(data.bets) && data.bets.length))) {
                    renderPrediction(data);
                  }
                }
              } catch {}
            };
            
            // Hacer funciones globales para compatibilidad con PredictionAccess
            (window as any).renderPrediction = renderPrediction;
            (window as any).autoOpenPrediction = autoOpen;
            (window as any).handlePredictionClick = () => {
              btn && btn.click();
            };
            
            if ('requestIdleCallback' in window) {
              // @ts-ignore
              window.requestIdleCallback(autoOpen);
            } else {
              setTimeout(autoOpen, 0);
            }

            // Event listener removed - now handled by PredictionAccess component
            /*
            btn.addEventListener('click', async () => {
              setLoading(true);
              err && err.classList.add('hidden');
              upsell && upsell.classList.add('hidden');
              try {
                const acc = await fetch('/api/predictions/access', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify({ matchId })
                }).then(r => r.json());
                if (acc.status === 'granted') {
                  const data = await fetch(`/api/predictions/${matchId}`, { credentials: 'include' }).then(r => r.json());
                  renderPrediction(data);
                } else if (acc.status === 'payment_required') {
                  upsell && upsell.classList.remove('hidden');
                  if (err) {
                    if (acc.reason === 'daily_free_limit_reached') {
                      err.textContent = 'Has consumido tu pron√≥stico gratis de hoy.';
                      // setHint(0) removed - handled by UsageLimits component
                    } else {
                      err.textContent = 'No tienes acceso a este pron√≥stico. Suscr√≠bete o compra este partido para verlo.';
                    }
                    err.classList.remove('hidden');
                  }
                } else {
                  // Si ya consumi√≥ gratis hoy, repetimos GET por si fue concedido en una sesi√≥n previa
                  try {
                    const data = await fetch(`/api/predictions/${matchId}`, { credentials: 'include' }).then(r => r.ok ? r.json() : null);
                    if (data && (data.text || (Array.isArray(data.bets) && data.bets.length))) {
                      const bets = Array.isArray(data?.bets) ? data.bets : [];
                      if (betsEl && bets.length) {
                        betsEl.classList.remove('hidden');
                        betsEl.innerHTML = '<div class="flex items-center justify-between mb-3">\
                            <h3 class="text-lg font-bold">Apuesta recomendada</h3>\
                          </div>' +
                          '<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">' +
                          bets.map(renderBetCard).join('') + '</div>';
                      }
                      if (out) out.textContent = data?.text || 'Pron√≥stico pr√≥ximamente.';
                      outWrap && outWrap.classList.remove('hidden');
                      btn.classList.add('hidden');
                      return;
                    }
                  } catch {}
                  if (err) { err.textContent = 'No tienes acceso a este pron√≥stico. Suscr√≠bete o compra este partido para verlo.'; err.classList.remove('hidden'); }
                }
              } catch (e) {
                if (err) { err.textContent = 'No hemos podido comprobar tu acceso ahora mismo. Int√©ntalo de nuevo en unos segundos.'; err.classList.remove('hidden'); }
              } finally {
                setLoading(false);
              }
            });
            */
            };
            if ('requestIdleCallback' in window) {
              // @ts-ignore
              window.requestIdleCallback(boot);
            } else {
              setTimeout(boot, 0);
            }
            
            // Funci√≥n global para compra de partido individual
            (window as any).handleMatchPurchase = async function(matchId) {
              try {
                console.log('üõí Starting match purchase for matchId:', matchId);
                
                const response = await fetch('/api/pay/match', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({ matchId: parseInt(matchId) }),
                });

                console.log('üì° API response status:', response.status);
                
                if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('üìÑ API response data:', data);
                
                if (data.error) {
                  console.error('‚ùå API returned error:', data.error);
                  alert('Error al procesar la compra: ' + data.error);
                  return;
                }

                if (data.checkoutUrl) {
                  console.log('üîÑ Redirecting to checkout:', data.checkoutUrl);
                  window.location.href = data.checkoutUrl;
                } else {
                  console.error('‚ùå No checkoutUrl in response:', data);
                  alert('Error: No se recibi√≥ la URL de pago');
                }
              } catch (error) {
                console.error('üí• Match purchase error:', error);
                alert('Error al procesar la compra. Por favor, int√©ntalo de nuevo.');
              }
            };
          })();
        </script>
      </section>

      <section class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4" style="content-visibility:auto;contain-intrinsic-size:1px 800px;">
        {/* Local team card */}
        <div class="card card-hover overflow-hidden">
          <div class="bg-gradient-to-r from-brand-50 to-white px-4 pt-4 pb-3 border-b border-gray-100">
            <div class="flex items-center gap-3">
              {match.home_logo && (
                <img
                  src={`/${String(match.home_logo).replace(/^\/?public\//,'').replace(/^\//,'')}`}
                  alt={`Escudo ${match.home_team_name}`}
                  title={match.home_team_name}
                  class="h-12 w-12 rounded-lg bg-white object-contain p-1 border border-gray-200 shadow-sm"
                  width="48"
                  height="48"
                  loading="lazy"
                  decoding="async"
                />
              )}
              <div class="min-w-0">
                <div class="text-xs uppercase tracking-wide text-gray-500">Local</div>
                <h3 class="font-bold text-lg text-gray-900 truncate">{match.home_team_name}</h3>
              </div>
              <div class="ml-auto flex items-center gap-2">
                {match.league_logo && (
                  <img
                    src={`/${String(match.league_logo).replace(/^\/?public\//,'').replace(/^\//,'')}`}
                    alt={match.league_name}
                    class="h-7 w-7 rounded-md bg-white object-contain p-1 border border-gray-200"
                    width="28"
                    height="28"
                    loading="lazy"
                    decoding="async"
                  />
                )}
                <span class="hidden sm:inline text-xs text-gray-600 truncate max-w-[120px]">{match.league_name}</span>
              </div>
            </div>
          </div>
          <div class="px-4 py-3">
            <dl class="space-y-2">
              {match.home_coach && (
                <div class="flex items-center gap-2 text-sm">
                  <svg class="h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm-7 9a7 7 0 0 1 14 0v1H5v-1z"/></svg>
                  <dt class="text-gray-500">Entrenador</dt>
                  <dd class="ml-auto font-medium text-gray-900 truncate">{match.home_coach}</dd>
                </div>
              )}
            </dl>
          </div>
        </div>

        {/* Away team card */}
        <div class="card card-hover overflow-hidden">
          <div class="bg-gradient-to-r from-white to-brand-50 px-4 pt-4 pb-3 border-b border-gray-100">
            <div class="flex items-center gap-3">
              {match.away_logo && (
                <img
                  src={`/${String(match.away_logo).replace(/^\/?public\//,'').replace(/^\//,'')}`}
                  alt={`Escudo ${match.away_team_name}`}
                  title={match.away_team_name}
                  class="h-12 w-12 rounded-lg bg-white object-contain p-1 border border-gray-200 shadow-sm"
                  width="48"
                  height="48"
                  loading="lazy"
                  decoding="async"
                />
              )}
              <div class="min-w-0">
                <div class="text-xs uppercase tracking-wide text-gray-500">Visitante</div>
                <h3 class="font-bold text-lg text-gray-900 truncate">{match.away_team_name}</h3>
              </div>
              <div class="ml-auto flex items-center gap-2">
                {match.league_logo && (
                  <img
                    src={`/${String(match.league_logo).replace(/^\/?public\//,'').replace(/^\//,'')}`}
                    alt={match.league_name}
                    class="h-7 w-7 rounded-md bg-white object-contain p-1 border border-gray-200"
                    width="28"
                    height="28"
                    loading="lazy"
                    decoding="async"
                  />
                )}
                <span class="hidden sm:inline text-xs text-gray-600 truncate max-w-[120px]">{match.league_name}</span>
              </div>
            </div>
          </div>
          <div class="px-4 py-3">
            <dl class="space-y-2">
              {match.away_coach && (
                <div class="flex items-center gap-2 text-sm">
                  <svg class="h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm-7 9a7 7 0 0 1 14 0v1H5v-1z"/></svg>
                  <dt class="text-gray-500">Entrenador</dt>
                  <dd class="ml-auto font-medium text-gray-900 truncate">{match.away_coach}</dd>
                </div>
              )}
            </dl>
          </div>
        </div>
      </section>

      {isPast && (
        <p class="text-xs text-gray-500 mt-4">Partido finalizado o en curso.</p>
      )}

<section class="not-prose mb-8 px-4 pt-4 ">
          <div class="flex flex-wrap items-center gap-2 text-xs text-gray-600">
            <a class="btn-ghost btn-xs" href={`/liga/${match.league_slug}`}>Clasificaci√≥n {match.league_name}</a>
            <a class="btn-ghost btn-xs" href="/proximos">Pr√≥ximos partidos</a>
            <div class="ml-auto flex items-center gap-2">
              <a class="btn-secondary btn-xs" href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`} target="_blank" rel="noopener">Compartir X</a>
              <a class="btn-secondary btn-xs" href={`https://wa.me/?text=${encodeURIComponent(shareText + ' ' + shareUrl)}`} target="_blank" rel="noopener">WhatsApp</a>
            </div>
          </div>
        </section>
        <section class="prose prose-sm max-w-none px-4 pt-4">
          <h2>Pron√≥stico de f√∫tbol con inteligencia artificial: {match.home_team_name} vs {match.away_team_name}</h2>
          <p>Pron√≥stico y previa de {match.league_name}. Evaluamos el {match.home_team_name} vs {match.away_team_name} con un modelo de <strong>valor esperado</strong> y t√©cnicas de <strong>inteligencia artificial</strong> para estimar probabilidades ajustadas.</p>

          <h3>Cuotas y probabilidades (valor esperado)</h3>
          <p>Analizamos las principales <strong>cuotas</strong> compar√°ndolas con <strong>precios justos</strong> del mercado. As√≠ identificamos valor en mercados como <strong>1X2</strong>, <strong>ambos marcan</strong> y <strong>over/under</strong>.</p>
          <h3>Apuesta recomendada y stake</h3>
          <p>Mostramos primero la apuesta recomendada, su cuota aproximada y una sugerencia de <strong>stake responsable</strong>. Recuerda que las cuotas pueden variar y que el riesgo nunca es cero.</p>
          <h3>Riesgos y escenarios</h3>
          <ul>
            <li>Sesgo por estado de forma y rotaciones de √∫ltima hora.</li>
            <li>Variabilidad en <strong>cuotas</strong> seg√∫n casa y momento.</li>
            <li>Condiciones de partido: bajas, clima y congesti√≥n de calendario.</li>
          </ul>
          <h3>Metodolog√≠a</h3>
          <p>El modelo combina m√©tricas ofensivas/defensivas recientes, fuerza del rival y <em>bayesian updating</em>. La salida se traduce a <strong>probabilidades</strong> y <strong>precios justos</strong> para los principales mercados.</p>
        </section>

      {bettingHouses && bettingHouses.length > 0 && (
        <section class="not-prose mt-8" style="content-visibility:auto;contain-intrinsic-size:1px 600px;">
          <h2 class="text-lg font-bold mb-3">Casas recomendadas para apostar</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {bettingHouses.map((bh) => {
              const color = normalizeHexColor(bh.color);
              const textClass = getContrastTextClass(color);
              const bgStyle = { backgroundColor: color };
              const link = bh.affiliate_url || bh.website_url;
              return (
                <a href={link} target="_blank" rel="sponsored nofollow noopener" class="block rounded-2xl overflow-hidden border border-gray-200 shadow-sm card-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500" style={bgStyle}>
                  <div class={`p-4 flex items-center gap-3 ${textClass}`}>
                    {bh.logo_file && (
                      <img src={`/${String(bh.logo_file).replace(/^\/?public\//,'').replace(/^\//,'')}`} alt={`Logo ${bh.name}`} width="80" height="80" loading="lazy" decoding="async" class="h-16 w-16 sm:h-20 sm:w-20 object-contain" />
                    )}
                    <div class="min-w-0">
                      <div class="text-sm/5 opacity-90">Casa de apuestas</div>
                      <div class="font-semibold text-base truncate">{bh.name}</div>
                    </div>
                    <div class="ml-auto">
                      <span class={`inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-xs font-medium border ${textClass === 'text-white' ? 'border-white/50' : 'border-black/10'} ${textClass === 'text-white' ? 'text-white' : 'text-gray-900'} bg-black/10`}>Promoci√≥n</span>
                    </div>
                  </div>
                  <div class={`px-4 pb-4 ${textClass}`}>
                    <p class="text-xs opacity-90">Oferta para nuevos usuarios. Consulta t√©rminos en la casa.</p>
                  </div>
                </a>
              );
            })}
          </div>
          <p class="mt-2 text-[11px] text-gray-500">Enlaces de afiliado. Juega con responsabilidad.</p>
        </section>
      )}
    </article>
  ) : (
    <div class="card p-6 text-red-600">Service unavailable</div>
  )}
</Base> 