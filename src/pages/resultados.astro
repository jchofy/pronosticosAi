---
// @ts-nocheck
import Base from '../layouts/Base.astro';
import { getRecentMatches } from '../lib/matches.js';
import { metaBasic } from '../lib/seo.js';
import { SITE_URL } from '../lib/env.js';

const url = new URL(Astro.request.url);
/** @type {number} */
const pageParam = Number(url.searchParams.get('page') || '1');
/** @type {{ rows: any[]; page: number; pageSize: number; hasNext: boolean }} */
let data = { rows: [], page: 1, pageSize: 50, hasNext: false };
/** @type {string|null} */
let error = null;
try {
  data = await getRecentMatches(30, pageParam, 50);
} catch (e) {
  error = 'Service unavailable';
  Astro.response.status = 503;
}

const siteUrl = SITE_URL;
const meta = metaBasic('Resultados recientes', 'Resultados de los últimos 30 días con acceso a fichas y pronósticos.', `${siteUrl}/resultados`);

const fmtDateTime = (s) => new Date(s).toLocaleString('es-ES', { dateStyle: 'medium', timeStyle: 'short' });
const page = data.page;
---
<Base { ...meta }>
  <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight mb-6">Resultados (últimos 30 días)</h1>
  { error ? (
    <div class="card p-6 text-red-600">{error}</div>
  ) : (
    <div class="overflow-x-auto card">
      <table class="min-w-full table-auto divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Liga</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Partido</th>
            <th class="px-4 py-3"></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 bg-white">
          {data.rows.map((m) => (
            <tr>
              <td class="px-4 py-3 text-sm text-gray-700 whitespace-nowrap">{fmtDateTime(m.date)}</td>
              <td class="px-4 py-3 text-sm text-gray-700 whitespace-nowrap">{m.league_name} · {m.league_country}</td>
              <td class="px-4 py-3 text-sm text-gray-900">{m.home_team} <span class="text-gray-400">vs</span> {m.away_team}</td>
              <td class="px-4 py-3 text-right">
                <a href={`/partido/${m.slug}`} class="text-brand-700 hover:underline">Ver ficha</a>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  )}

  <div class="mt-4 flex items-center justify-between">
    <a class={`btn-primary ${page <= 1 ? 'pointer-events-none opacity-50' : ''}`} href={`/resultados?page=${Math.max(1, page - 1)}`}>← Anteriores</a>
    <a class={`btn-primary ${!data.hasNext ? 'pointer-events-none opacity-50' : ''}`} href={`/resultados?page=${page + 1}`}>Siguientes →</a>
  </div>
</Base> 