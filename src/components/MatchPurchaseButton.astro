---
import { getSession } from 'auth-astro/server';
import { query } from '../lib/db.js';

const { matchId, matchSlug } = Astro.props;

// Verificar sesi√≥n
const session = await getSession(Astro.request);
const isLoggedIn = !!session?.user;

let hasPurchased = false;
let hasSubscription = false;

if (isLoggedIn && session?.user?.email) {
  // Obtener el ID del usuario
  const users = await query(
    'SELECT id FROM users WHERE email = ? LIMIT 1',
    [session.user.email]
  );
  
  if (users.length > 0) {
    const userId = users[0].id;
    
    // Verificar si el usuario ya compr√≥ este partido
    const purchases = await query(
      'SELECT id FROM payments WHERE user_id = ? AND match_id = ? AND type = "match" AND status = "active" LIMIT 1',
      [userId, matchId]
    );
    hasPurchased = purchases.length > 0;

    // Verificar si tiene una suscripci√≥n activa
    const subscriptions = await query(
      'SELECT id FROM payments WHERE user_id = ? AND type = "subscription" AND status = "active" AND current_period_end > NOW() LIMIT 1',
      [userId]
    );
    hasSubscription = subscriptions.length > 0;
  }
}

// El bot√≥n de compra ahora se maneja en PredictionAccessButton
// Este componente se mantiene para compatibilidad
const showPurchaseButton = !hasPurchased && !hasSubscription;
---

{showPurchaseButton && (
  <>
    {isLoggedIn ? (
      <button
        id="purchaseButton"
        class="block w-full rounded-lg bg-[#254FB1] px-4 py-2.5 text-center text-sm font-medium text-white shadow-sm hover:from-primary-600 hover:to-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:ring-offset-gray-900"
        data-match-id={matchId}
      >
        Comprar predicci√≥n
      </button>
    ) : (
      <a
        href={`/login?redirect=/partido/${matchSlug}`}
        class="block w-full rounded-lg bg-[#254FB1] px-4 py-2.5 text-center text-sm font-medium text-white shadow-sm hover:from-primary-600 hover:to-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:ring-offset-gray-900"
      >
        Iniciar sesi√≥n para comprar
      </a>
    )}
  </>
)}

<script>
  // Funci√≥n para manejar la compra
  async function handlePurchase(matchId) {
    try {
      console.log('üõí Starting purchase for match:', matchId);
      
      const response = await fetch('/api/pay/match', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ matchId }),
      });

      console.log('üì° Response status:', response.status);
      console.log('üì° Response ok:', response.ok);

      const data = await response.json();
      console.log('üìã Response data:', data);
      
      if (data.error) {
        console.error('‚ùå Server error:', data.error);
        console.error('‚ùå Error details:', data.details);
        
        if (data.error === 'already_purchased') {
          alert('Ya has comprado este partido.');
        } else {
          const errorMsg = data.details ? 
            `Error: ${data.details}` : 
            'Error al procesar la compra. Por favor, int√©ntalo de nuevo.';
          alert(errorMsg);
        }
        return;
      }

      if (data.checkoutUrl) {
        console.log('‚úÖ Redirecting to checkout:', data.checkoutUrl);
        window.location.href = data.checkoutUrl;
      } else {
        console.error('‚ùå No checkout URL received');
        alert('Error: No se pudo obtener la URL de pago.');
      }
    } catch (error) {
      console.error('‚ùå Client error:', error);
      alert('Error al conectar con el servidor. Por favor, int√©ntalo de nuevo.');
    }
  }

  // A√±adir event listener al bot√≥n de compra
  const purchaseButton = document.getElementById('purchaseButton');
  if (purchaseButton) {
    console.log('üéØ Purchase button found, adding event listener');
    purchaseButton.addEventListener('click', () => {
      const matchId = purchaseButton.dataset.matchId;
      console.log('üé¨ Button clicked, match ID:', matchId);
      handlePurchase(matchId);
    });
  } else {
    console.log('‚ùå Purchase button not found');
  }
</script>
